---
title: "REFSA COVID-19 Responseâ€”MCO 2.0"
author: "REFSA Research Team"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output: 
  html_document: 
    keep_md: true
fig.width: 6
fig.asp: 0.618
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

# Load libraries
library(tidyverse)
library(ggplot2)
library(scales)
library(lubridate)
library(dplyr)
library(zoo)
library(hrbrthemes)

# Load REFSA logo
# refsa_logo <- png::readPNG("Logo.png")

# Load data

# ===== Google Mobility Reports =====
# https://www.apple.com/covid19/mobility (alternative source)
mobi <- read_csv("2020_MY_Region_Mobility_Report.csv")

# ===== Covid test and cases (Our World in Data) =====
# https://github.com/owid/covid-19-data/blob/master/public/data/jhu/new_cases_per_million.csv (Cases are per million population!)
covid_cases <- read_csv("https://raw.githubusercontent.com/owid/covid-19-data/master/public/data/jhu/new_cases_per_million.csv")

# ===== Covid test data (Our World in Data) =====
# https://github.com/owid/covid-19-data/blob/master/public/data/testing/covid-testing-all-observations.csv
covid_tests <- read_csv("https://raw.githubusercontent.com/owid/covid-19-data/master/public/data/testing/covid-testing-all-observations.csv")

```


This tracker brings together a number of oft-referred to statistics to monitor the evolution of the Covid-19 pandemic in Malaysia, and highlight some interesting data points. As of now, the following data is included: 

 1. Daily count of tests, cases and test positivity rate
 2. Mobility data, based on Google's Covid-19 location data
 
## Tests, cases and positivity rate

Source: Our World In Data. 

```{r covid-19-linear, echo=FALSE}

# ===== Data wrangling =====

# Convert case data to a denormalised tibble. Pivot all columns except "Date" into a "country" column and a "cases" column
covid_cases_pivot <- covid_cases %>% pivot_longer(!date, names_to = "country", values_to = "cases")

# Filter COVID-19 data for Malaysia and South Korea, from 2020-10-31 to 2021-02-28

# Define filter values
iso_codes <- c("MYS", "KOR")
countries <- c("Malaysia", "South Korea")

date_from <- ymd("2020-09-30")
date_to <- ymd("2021-03-01")

# Filter case data and rename columns for ease of use; add an ISO code column for easy matching
covid_cases_m <- filter(covid_cases_pivot, country %in% countries & date > date_from & date < date_to)
covid_cases_m <- rename(covid_cases_m, 
                        record.date = `date`,
                        daily.cases.per.million = `cases`)
covid_cases_m <- covid_cases_m %>% mutate(ISO.code = case_when(
  country == "Malaysia" ~ "MYS",
  country == "South Korea" ~ "KOR",
  TRUE ~ country
))

# Filter tests data according to parameters and only useful columns; rename columns for ease of use
covid_tests_m <- filter(covid_tests, covid_tests$`ISO code` %in% iso_codes & covid_tests$Date > date_from & covid_tests$Date < date_to) %>% select(c("ISO code", "Date", "Daily change in cumulative total", "Daily change in cumulative total per thousand", "7-day smoothed daily change", "7-day smoothed daily change per thousand", "Short-term positive rate", "Short-term tests per case")) 
covid_tests_m <- rename(covid_tests_m, 
      ISO.code = `ISO code`, 
      record.date = `Date`,
      daily.tests = `Daily change in cumulative total`, 
      daily.tests.per.thousand = `Daily change in cumulative total per thousand`, 
      smoothed.daily.change = `7-day smoothed daily change`, 
      smoothed.daily.change.per.thousand = `7-day smoothed daily change per thousand`, 
      st.pos.rate = `Short-term positive rate`, 
      st.tests.per.case = `Short-term tests per case`)

# Filter NA's and sort rows in ascending order (by Date)
covid_cases_m <- arrange(covid_cases_m, record.date)
covid_tests_m <- arrange(covid_tests_m, record.date)

# Merge cases and tests data
covid_all <- covid_tests_m %>% left_join(covid_cases_m, by = c("ISO.code", "record.date"))


```

### Evolution of testing 

```{r covid-daily-tests}

# New facet labels for countries
country.labs <- c("South Korea", "Malaysia")
names(country.labs) <- c("KOR", "MYS")

# Plot daily tests (per thousand)
covid_dailytests_plot <- ggplot(data = covid_all, aes(x = record.date)) + 
  geom_bar(aes(y = daily.tests.per.thousand, colour = ISO.code), stat = "identity") + 
  scale_x_date(name = "Date") +
  scale_y_continuous(name = "Count") + 
  labs(title = "Daily tests per thousand for South Korea and Malaysia", caption = "From 01-Oct-2020 to 28-Feb-2021. Source: Our World In Data.") +
  theme(legend.position = "none")

covid_dailytests_plot + facet_wrap( ~ ISO.code)

```

### Evolution of daily cases

```{r covid-daily-cases}

# Plot daily cases (per million) 
covid_dailycases_plot <- ggplot(data = covid_all, aes(x = record.date)) + 
  geom_bar(aes(y = daily.cases.per.million, colour = ISO.code), stat = "identity") + 
  scale_x_date(name = "Date") +
  scale_y_continuous(name = "Count") + 
  labs(title = "Daily cases per million for South Korea and Malaysia", caption = "From 01-Oct-2020 to 28-Feb-2021. Source: Our World In Data.") +
  theme(legend.position = "none")

covid_dailycases_plot + facet_wrap( ~ ISO.code)

```

### Evolution of test positivity rate

This rate shows the short-term positivity rate of tests. 

```{r covid-posrate}

# Plot test positivity rate
covid_posrate_plot <- ggplot(data = covid_all) + 
  geom_line(aes(x = record.date, y = st.pos.rate, color = ISO.code)) +
  scale_x_date(name = "Date") +
  scale_y_continuous(labels = scales::percent, name = "Percent") + 
  labs(title = "Short-term test positivity rate for South Korea and Malaysia", caption = "From 01-Oct-2020 to 28-Feb-2021. Source: Our World In Data.") + 
  theme(legend.position = "none")

covid_posrate_plot + facet_wrap(~ ISO.code)

```

## Mobility

Analysis of mobility is based on Google's data for Malaysia. 
The charts below show the percent change compared to a baseline. The baseline is the median number of daily routing requests between early January to early February 2020. 

```{r mobility, echo=FALSE}

# Filter the raw data to only include nationwide change and correct date range
mobi_nation <- filter(mobi, is.na(sub_region_1) & date > date_from & date < date_to)
mobi_nation <- rename(mobi_nation, 
                      retail.rec = "retail_and_recreation_percent_change_from_baseline", 
                      grocery.pharmacy = "grocery_and_pharmacy_percent_change_from_baseline", 
                      parks = "parks_percent_change_from_baseline", 
                      transit = "transit_stations_percent_change_from_baseline", 
                      workplaces = "workplaces_percent_change_from_baseline", 
                      residential = "residential_percent_change_from_baseline")

# New facet labels for place categories
dest_cats.labs <- c("Retail & Rec", "Grocery & Pharmacy", "Parks", "Transit Stations", "Workplaces", "Residential")
names(dest_cats.labs) <- c("retail.rec", "grocery.pharmacy", "parks", "transit", "workplaces", "residential")

# The data is shown in tabular format, not very useful for analysis, so need to pivot the different categories into one column
mobi_nation <- mobi_nation %>% pivot_longer(c("retail.rec", "grocery.pharmacy", "parks", "transit", "workplaces", "residential"), names_to = "category", values_to = "change.from.baseline")

```

### Change from baseline across categories

This chart shows the change in destinations relative to a pre-pandemic baseline, smoothed using a 7-day rolling average. Each time movement restrictions are announced, there is a noticeable drop in retail and recreation destinations as well as transit stations. 

```{r mobi-plot-all}

# Filter the table to pick up only national data; Add a column with 7-day rolling average
mobi_nation <- mobi_nation %>% arrange(desc(category)) %>%
  group_by(category) %>%
  mutate(change.from.baseline.smooth = rollmean(change.from.baseline, 7, fill = NA)) %>%
  ungroup()

# plot the data; re-using the labels defined in the mobility block. 
mobi_plot <- ggplot(data = mobi_nation) +
  geom_area(aes(x = date, y = change.from.baseline.smooth, color = category, fill = category), alpha = 0.33) +
  scale_x_date(name = "Date") +
  scale_y_continuous(name = "Change from baseline (%)") +
  theme(legend.position = "none")

mobi_plot + facet_wrap(~ category, labeller = labeller(category = dest_cats.labs))

```

The effect of the resumption of interstate travel on 2020-12-07 is well visible in the "Transit Stations" category. From that day there is a clear uptick in the number of requests for transit stations. Looking at that chart in isolation: 

```{r mobility-transit, echo=FALSE}

mobi_plot_transit <- ggplot(data = filter(mobi_nation, category == "transit")) +
  geom_area(aes(x = date, y = change.from.baseline), color = "#1252B3", fill = "#0D6EFF", alpha = 0.33) +
  scale_x_date(name = "Date") +
  scale_y_continuous(name = "Change from baseline (%)") +
  theme(legend.position = "none") +
  geom_vline(xintercept = ymd("2020-12-06")) +
  geom_text(mapping = aes(x = ymd("2020-12-06"), y = 0, label = "interstate travel", hjust = 0, vjust = 0)) +
  geom_vline(xintercept = ymd("2020-10-14")) +
  geom_text(mapping = aes(x = ymd("2020-10-14"), y = 0, label = "MCO 2.0", hjust = 0, vjust = 0)) + 
  geom_vline(xintercept = ymd("2021-01-13")) +
  geom_text(mapping = aes(x = ymd("2021-01-13"), y = 0, label = "MCO 3.0", hjust = 0, vjust = 0))

mobi_plot_transit

```

For further analysis, we could look to include economic data (high frequency indicators would be best), and relate that to the evolution of the pandemic and the mobility data. 

