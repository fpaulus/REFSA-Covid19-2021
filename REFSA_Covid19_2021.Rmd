---
title: "REFSA COVID-19 Responseâ€”MCO 2.0"
author: "REFSA Research Team"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output: 
  html_document: 
    keep_md: true
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

# Load libraries
library(tidyverse)
library(ggplot2)
library(scales)
library(lubridate)
library(dplyr)
library(zoo)
library(hrbrthemes)

# Load REFSA logo
# refsa_logo <- png::readPNG("Logo.png")

# Load data

# ===== Google Mobility Reports =====
# https://www.apple.com/covid19/mobility (alternative source)
# mobi <- read_csv("https://www.gstatic.com/covid19/mobility/Global_Mobility_Report.csv")

# ===== Covid test and cases (Our World in Data) =====
# https://github.com/owid/covid-19-data/blob/master/public/data/jhu/new_cases_per_million.csv (Cases are per million population!)
covid_cases <- read_csv("https://raw.githubusercontent.com/owid/covid-19-data/master/public/data/jhu/new_cases_per_million.csv")

# ===== Covid test data (Our World in Data) =====
# https://github.com/owid/covid-19-data/blob/master/public/data/testing/covid-testing-all-observations.csv
covid_tests <- read_csv("https://raw.githubusercontent.com/owid/covid-19-data/master/public/data/testing/covid-testing-all-observations.csv")

```


## Objective

Malaysia is currently struggling to deal with the third wave of the Covid-19 pandemic. This analysis aims to highlight a few data points that illuminate the response so far of the government, and where additional investment may be required. 

 1. Test positivity rate, and the need to perform more testing
 2. Changes in mobility, related to the positivity rate
 
## Test positivity rate

The test positivity rate is still quite elevated in Malaysia, above the minimum threshold recommended by the WHO (5%), and especially high compared to a successful country in managing Covid-19, South Korea. The following charts depict the evolution of number of new cases, number of tests, and positivity rate. All data is 7-day smoothed (rolling average); people tested are per 1,000 population; new daily cases are per million population.

Source: Our World In Data. 

```{r covid-19-linear, echo=FALSE}

# ===== Data wrangling =====

# Convert case data to a denormalised tibble. Pivot all columns except "Date" into a "country" column and a "cases" column
covid_cases_pivot <- covid_cases %>% pivot_longer(!date, names_to = "country", values_to = "cases")

# Filter COVID-19 data for Malaysia and South Korea, from 2020-10-31 to 2021-02-28

# Define filter values
iso_codes <- c("MYS", "KOR")
countries <- c("Malaysia", "South Korea")

covid_cases_m <- filter(covid_cases_pivot, country %in% countries & date > ymd("2020-10-31") & date < ymd("2021-03-01"))
covid_tests_m <- filter(covid_tests, covid_tests$`ISO code` %in% iso_codes & covid_tests$Date > ymd("2020-10-31") & covid_tests$Date < ymd("2021-03-01"))

# Filter NA's and sort rows in ascending order (by Date)
covid_cases_m <- arrange(covid_cases_m, date)
covid_tests_m <- arrange(covid_tests_m, Date)



```

```{r covid-plot, echo=FALSE}

# New facet labels for countries
country.labs <- c("South Korea", "Malaysia")
names(country.labs) <- c("KOR", "MYS")

# Plot daily tests
covid_dailytests_plot <- ggplot(data = covid_tests_m) + 
#  geom_bar(aes(y = covid_test_data_m$`Daily change in cumulative total`), stat = "identity", size = .1, fill = "#FFDE00", color = "#FFDE00", alpha = .6) +  
  geom_line(aes(x = covid_tests_m$Date, y = covid_tests_m$`7-day smoothed daily change per thousand`, color = covid_tests_m$`ISO code`)) +
  scale_x_date(name = "Date") +
  scale_y_continuous() + 
  labs(title = "Daily tests for South Korea and Malaysia (7-day rolling average)", caption = "From 01-Nov-2020 to 28-Feb-2021. Source: Our World In Data.")

covid_dailytests_plot

# Plot test positivity rate
covid_posrate_plot <- ggplot(data = covid_tests_m) + 
#  geom_bar(aes(y = covid_test_data_m$`Daily change in cumulative total`), stat = "identity", size = .1, fill = "#FFDE00", color = "#FFDE00", alpha = .6) +  
  geom_line(aes(x = covid_tests_m$Date, y = covid_tests_m$`Short-term positive rate`, color = covid_tests_m$`ISO code`)) +
  scale_x_date(name = "Date") +
  scale_y_continuous() + 
  labs(title = "Short-term test positivity rate for South Korea and Malaysia", caption = "From 01-Nov-2020 to 28-Feb-2021. Source: Our World In Data.")

covid_posrate_plot



```

## Mobility
Analysis of mobility is based on Google's data for Malaysia. 
The charts below show the percent change compared to a baseline. The baseline is the median number of daily routing requests between early January to early February 2020. 

```{r mobility, echo=FALSE}

# Filter the raw data to only include nationwide change and correct date range
mobi_nation <- filter(mobi, is.na(sub_region_1) & date > ymd("2020-08-31"))

# New facet labels for place categories
dest_cats.labs <- c("Retail & Rec", "Grocery & Pharmacy", "Parks", "Transit Stations", "Workplaces", "Residential")
names(dest_cats.labs) <- c("retail_and_recreation_percent_change_from_baseline", "grocery_and_pharmacy_percent_change_from_baseline", "parks_percent_change_from_baseline", "transit_stations_percent_change_from_baseline", "workplaces_percent_change_from_baseline", "residential_percent_change_from_baseline")

# The data is shown in tabular format, not very useful for analysis, so need to pivot the different categories into one column
mobi_nation_pivot <- mobi_nation %>% pivot_longer(c("retail_and_recreation_percent_change_from_baseline", "grocery_and_pharmacy_percent_change_from_baseline", "parks_percent_change_from_baseline", "transit_stations_percent_change_from_baseline", "workplaces_percent_change_from_baseline", "residential_percent_change_from_baseline"), names_to = "category", values_to = "change_from_baseline")

# plot the data
mobi_plot <- ggplot(data = mobi_nation_pivot) +
  geom_line(aes(x = date, y = change_from_baseline, color = category)) +
  scale_x_date(name = "Date") +
  scale_y_continuous(name = "Change from baseline (%)") +
  theme(legend.position = "none")

mobi_plot + facet_wrap(~ category, labeller = labeller(category = dest_cats.labs))

```

The effect of the resumption of interstate travel on 2020-12-07 is well visible in the "Transit Stations" category. From that day there is a clear uptick in the number of requests for transit stations. Looking at that chart in isolation: 



```{r mobility-transit, echo=FALSE}

mobi_plot_transit <- ggplot(data = filter(mobi_nation_pivot, category == "transit_stations_percent_change_from_baseline")) +
  geom_area(aes(x = date, y = change_from_baseline), color = "#1252B3", fill = "#0D6EFF", alpha = 0.33) +
  scale_x_date(name = "Date") +
  scale_y_continuous(name = "Change from baseline (%)") +
  theme(legend.position = "none") +
  geom_vline(xintercept = ymd("2020-12-06")) +
  geom_text(mapping = aes(x = ymd("2020-12-06"), y = 0, label = "interstate travel", hjust = 0, vjust = 0))

mobi_plot_transit

```

In order to see the trend better, we also compute a 7-day rolling average for the same data, across the whole data set. 

```{r mobility-7da, echo=FALSE}

# Pivot the full table to move all destination categories to one column. 
mobi_full_pivot <- mobi %>% pivot_longer(c("retail_and_recreation_percent_change_from_baseline", "grocery_and_pharmacy_percent_change_from_baseline", "parks_percent_change_from_baseline", "transit_stations_percent_change_from_baseline", "workplaces_percent_change_from_baseline", "residential_percent_change_from_baseline"), names_to = "category", values_to = "change_from_baseline")

# Filter the table to pick up only national data; Add a column with 7-day rolling average
mobi_7da <- filter(mobi_full_pivot, is.na(sub_region_1)) %>%
  arrange(desc(category)) %>%
  group_by(category) %>%
  mutate(change_from_baseline_7da = rollmean(change_from_baseline, 21, fill = NA)) %>%
  ungroup()

# plot the data; re-using the labels defined in the mobility block. 
mobi_plot <- ggplot(data = mobi_7da) +
  geom_area(aes(x = date, y = change_from_baseline_7da, color = category, fill = category), alpha = 0.33) +
  scale_x_date(name = "Date") +
  scale_y_continuous(name = "Change from baseline (%)") +
  theme(legend.position = "none")

mobi_plot + facet_wrap(~ category, labeller = labeller(category = dest_cats.labs))


```

## Test positivity rate vs mobility
The chart below shows the evolution of the test positivity rate and the mobility data related to transit stations. 

```{r posrate-mobility, echo=FALSE}

# Filter the mobility date to keep only the transit stations
mobi_nation_transit <- filter(mobi_nation_pivot, category == "transit_stations_percent_change_from_baseline")

# Filter the test positivity data for Malaysia only; recalculate the positivity rate
testdata_my <- filter(covid_data, Code == "MYS" & Date > ymd("2020-08-31") & Date < ymd("2021-01-23"))
testposrate_my <- testdata_my %>% mutate(DailyPosRate = (DailyCases / (DailyTests * 1000)) * 100)

# Join the mobility table with the test positivity rate table
# First rename the 'date' column in the mobility data to 'Date' for the join to work
mobi_nation_transit <- mobi_nation_transit %>% rename(Date = date)

testposrate_mobi_my <- testposrate_my %>% select(-Year, -Continent, -DailyTestsNotes) %>% left_join(mobi_nation_transit, by = "Date")

tpr_mobi_p <- ggplot(data = testposrate_mobi_my) +
  geom_line(aes(x = Date, y = DailyPosRate), color = "red") + 
  geom_line(aes(x = Date, y = change_from_baseline), color = "blue")

tpr_mobi_p


```